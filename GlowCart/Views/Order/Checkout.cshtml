@model IEnumerable<GlowCart.Entities.Models.Cart>

@{
    ViewBag.Title = "Checkout";
    Layout = null; // remove if you already have _Layout.cshtml
}

<!-- ✅ Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<link rel="stylesheet" href="~/css/checkout.css" asp-append-version="true" />

<div class="container mt-5 mb-5">
    <div class="row">
        <!-- 🧾 LEFT: Cart Summary -->
        <div class="col-lg-7">
            <div class="card shadow-lg border-0 mb-4">
                <div class="card-header bg-dark text-warning fw-bold fs-5">
                    🛒 Order Summary
                </div>
                <div class="card-body bg-dark text-light">
                    @if (Model == null || !Model.Any())
                    {
                        <div class="alert alert-warning text-center fw-bold fs-5">
                            ⚠️ Your cart is empty. <a href="/Product/GetProducts" class="text-decoration-none text-primary">Shop Now</a>
                        </div>
                    }
                    else
                    {
                        <table class="table table-dark table-hover text-center align-middle">
                            <thead class="table-warning text-dark">
                                <tr>
                                    <th>Product</th>
                                    <th>Image</th>
                                    <th>Qty</th>
                                    <th>Price (₹)</th>
                                    <th>Total (₹)</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Model)
                                {
                                    <tr>
                                        <td>@item.ProductName</td>
                                        <td><img src="@Url.Content("~/images/" + item.ImageUrl)" width="70" class="rounded shadow-sm" /></td>
                                        <td>@item.Quantity</td>
                                        <td>@item.Price.ToString("0.00")</td>
                                        <td>@item.Total.ToString("0.00")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                        <div class="text-end mt-3 fs-5 fw-bold">
                            Total Payable: <span class="text-warning">₹@Model.Sum(x => x.Total).ToString("0.00")</span>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- 🏠 RIGHT: Shipping Address + Checkout -->
        <div class="col-lg-5">
            <div class="card shadow-lg border-0">
                <div class="card-header bg-success text-white fw-bold fs-5">
                    🚚 Shipping Details
                </div>
                <div class="card-body bg-light">
                    <form id="checkoutForm">
                        <div class="mb-3">
                            <label for="address" class="form-label fw-bold">Shipping Address</label>
                            <textarea id="address" class="form-control" rows="4" placeholder="Enter your complete address..." required></textarea>
                        </div>
                        <div class="d-grid gap-2 mt-4">
                            <button type="submit" class="btn btn-success fw-bold py-2">💳 Place Order</button>
                            <a href="/Cart/ViewCart" class="btn btn-outline-dark fw-bold py-2">← Back to Cart</a>
                        </div>
                    </form>
                    <p class="mt-3 fw-bold text-center" id="checkoutMessage"></p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ✅ Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    $(document).ready(function () {
        $("#checkoutForm").submit(function (e) {
            e.preventDefault();

            const address = $("#address").val().trim();

            if (address === "") {
                $("#checkoutMessage").text("⚠️ Please enter your shipping address.").css("color", "red");
                return;
            }

            $.ajax({
                url: '/Order/PlaceOrder',
                type: 'POST',
                data: { shippingAddress: address },
                success: function (response) {
                    if (response.success) {
                        $("#checkoutMessage").text(response.message).css("color", "green");
                        setTimeout(() => {
                            window.location.href = "/Product/GetProducts";
                        }, 2000);
                    } else {
                        $("#checkoutMessage").text(response.message).css("color", "red");
                    }
                },
                error: function () {
                    $("#checkoutMessage").text("⚠️ Server error occurred. Please try again later.").css("color", "red");
                }
            });
        });
    });
</script>
