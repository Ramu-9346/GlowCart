@model IEnumerable<GlowCart.Entities.Models.Product>

<link rel="stylesheet" href="~/css/admin-products.css" />

<div id="productSection" class="admin-products-container">

    <h4 class="page-title">🛍️ Product Management</h4>

    <!-- 🔍 Filter Bar -->
    <div class="filter-bar">
        <input type="text" id="txtSearch" placeholder="Search products..." class="search-box" />

        <button class="btn-filter active" data-filter="all">All</button>
        <button class="btn-filter" data-filter="instock">In Stock</button>
        <button class="btn-filter" data-filter="outstock">Out of Stock</button>

        <button id="btnRefresh" class="btn-refresh">
            <i class="bi bi-arrow-clockwise"></i>
        </button>

        <button id="btnAddProduct" class="btn-add">
            <i class="bi bi-plus-lg"></i> Add New Product
        </button>
    </div>

    <!-- 🧾 Product Table -->
    <div class="table-container">
        <table class="data-grid">
            <thead>
                <tr>
                    <th>Product ID</th>
                    <th>Product Name</th>
                    <th>Brand</th>
                    <th>Price (₹)</th>
                    <th>Status</th>
                    <th style="text-align:center;">Actions</th>
                </tr>
            </thead>

            <tbody id="productTableBody">
                @foreach (var item in Model)
                {
                    <tr class="@(item.IsAvailable ? "" : "outstock")" data-id="@item.ProductId">
                        <td>@item.ProductId</td>
                        <td>@item.ProductName</td>
                        <td>@item.Brand</td>
                        <td>@item.Price</td>

                        <td>
                            <span class="status-dot @(item.IsAvailable ? "instock" : "outstock")">
                                <span class="dot"></span>
                                @(item.IsAvailable ? "In Stock" : "Out of Stock")
                            </span>
                        </td>

                        <td class="act-col">
                            <button class="action-btn edit"><i class="bi bi-pencil-fill"></i></button>
                            <button class="action-btn delete"><i class="bi bi-trash-fill"></i></button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- 🔵 CUSTOM MODAL -->
<div id="productModal" class="custom-modal">
    <div class="modal-box">

        <div class="modal-header">
            <span id="modalTitle"></span>
            <button class="close-btn" onclick="closeProductModal()">✖</button>
        </div>

        <div class="modal-body" id="modalContent">
            @Html.Partial("_AddEditProduct")
        </div>

    </div>
</div>


<!-- ========================================================== -->
<!--     FULL SCRIPT – INCLUDING GRID RELOAD LOGIC             -->
<!-- ========================================================== -->
<script>

    // ==========================================================
    // 🔄 RELOAD PRODUCT GRID ONLY (NO PAGE REFRESH)
    // ==========================================================
    function reloadProductsGrid() {
        $("#productSection").load("/Admin/_Products", function () {
            console.log("🔄 Grid refreshed without reloading whole page.");
        });
    }


    $(document).ready(function () {

        // 🔍 Search
        $("#txtSearch").on("keyup", function () {
            let val = $(this).val().toLowerCase();
            $("#productTableBody tr").filter(function () {
                $(this).toggle($(this).text().toLowerCase().includes(val));
            });
        });

        // 🟢 Filter buttons
        $(".btn-filter").click(function () {
            $(".btn-filter").removeClass("active");
            $(this).addClass("active");

            let filter = $(this).data("filter");
            $("#productTableBody tr").show();

            if (filter === "instock") $(".outstock").hide();
            if (filter === "outstock") $("#productTableBody tr:not(.outstock)").hide();
        });

        // 🔁 Refresh
        $("#btnRefresh").click(function () {
            $("#txtSearch").val("");
            $(".btn-filter[data-filter='all']").click();
        });

        // ➕ ADD PRODUCT
        $("#btnAddProduct").click(function () {
            openProductModal("add");
        });

        // ✏ EDIT PRODUCT
        $(document).on("click", ".action-btn.edit", function () {
            let id = $(this).closest("tr").data("id");

            $.get("/Admin/GetProduct", { id }, function (res) {
                if (res.success) {
                    openProductModal("edit", res.product);
                } else {
                    alert("Unable to load product.");
                }
            });
        });

        // 🗑 DELETE PRODUCT
        $(document).on("click", ".action-btn.delete", function () {
            let id = $(this).closest("tr").data("id");

            if (!confirm("Delete this product?")) return;

            $.post("/Admin/DeleteProduct", { id }, function (res) {
                alert(res.message);
                if (res.success) reloadProductsGrid();
            });
        });
    });


    // OPEN MODAL
    function openProductModal(mode, product = null) {

        $("#productForm")[0].reset();
        $("#ProductId").val("");

        $("#imagePreview").attr("src", "/images/noimage.png");

        if (mode === "add") {
            $("#modalTitle").text("➕ Add New Product");
        }
        else {
            $("#modalTitle").text("✏ Edit Product");

            $("#ProductId").val(product.productId);
            $("#ProductName").val(product.productName);
            $("#Brand").val(product.brand);
            $("#Price").val(product.price);
            $("#IsAvailable").val(product.isAvailable ? "true" : "false");

            let imgSrc = product.imageUrl ? "/images/" + product.imageUrl : "/images/noimage.png";
            $("#imagePreview").attr("src", imgSrc);
        }

        $("#productModal").show();
    }

    // CLOSE MODAL
    function closeProductModal() {
        $("#productModal").hide();
    }

</script>
